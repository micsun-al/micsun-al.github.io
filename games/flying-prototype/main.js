(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{1645:function(t,e,i){"use strict";i.r(e);i(724);var s=i(21),a=i(26);const n={ID:"main",IMAGE:"assets/sheets/main.png",DATA:"assets/sheets/main.json"};const r={explosion:new class{constructor(t,e,i=10,s=128,a,n=0,r=31){this.key=t,this.path=e,this.frameRate=i,this.frameWidth=s,this.frameHeight=a,this.start=n,this.end=r,this.frameHeight||(this.frameHeight=s),this.animationKey=`${t}-animation`}}("explosion","assets/sheets/explosion_animation_1024x512_32c.png",10,128,128,0,31)},h={gotham_ultra_italic:{ID:"gotham_ultra_italic",IMAGE:"assets/fonts/gotham_ultra.png",DATA:"assets/fonts/gotham_ultra.fnt"}},o={aircraft:{ID:"aircraft-mesh"},projectile:{ID:"projectile-mesh"},objective:{ID:"objective-mesh"}},l={audioVolume:{ID:"AUDIO_VOLUME",DEFAULT:.5},audioMute:{ID:"AUDIO_MUTE",DEFAULT:!1},playerPosition:{ID:"PLAYER_POSITION",DEFAULT:a.h.Zero()},playerRotation:{ID:"PLAYER_ROTATION",DEFAULT:a.h.Zero()},playerSpeed:{ID:"PLAYER_SPEED",DEFAULT:.1},playerDistance:{ID:"PLAYER_DISTANCE",DEFAULT:.01},playerScore:{ID:"PLAYER_SCORE",DEFAULT:0},playerMultiplier:{ID:"PLAYER_MULTIPLIER",DEFAULT:1},timeRemaining:{ID:"TIME_REMAINING",DEFAULT:6e4},music:{ID:"MUSIC",DEFAULT:null},joystickHorizontal:{ID:"JOYSTICK_HORIZONTAL",DEFAULT:0},joystickVertical:{ID:"JOYSTICK_VERTICAL",DEFAULT:0}},c="MATERIALS_ALL_LOADED",u="REFLOW_REQUESTED",p="INPUT_A",m="SUMMARY_REPLAY_REQUESTED",d="REQUEST_MUSIC",g="REQUEST_SOUND",_="STOP_MUSIC",y="LOAD_PROGRESS",b="PLAYER_CRASHED",S="SCORE_ADD",f="SCORE_BURST",v="MULTIPLIER_ADD",D=720,I=1280,w={SCORE_MULTIPLIER:1,ACCELERATION_DURATION:2e3,SPEED_NORMAL:.1,SPEED_MIN:.1,SPEED_MAX:.3,ACCELERATION_MULTIPLIER:5e-5,DECELERATION_MULTIPLIER:3e-4,SCORE_OBJECTIVE_TOUCH_MAX:1e3,SCORE_OBJECTIVE_TOUCH_MIN:100,SCORE_OBJECTIVE_SHOT_MAX:10,SCORE_OBJECTIVE_SHOT_MIN:1,MULTIPLIER_MIN:1,MULTIPLIER_DECAY_SPEED:.0025,GRAVITY_VECTOR:new a.h(0,0,0),PROJECTILE_SPEED:.2,PROJECTILE_DURATION:500,PROJECTILE_FRONT_MULTIPLIER:new a.h(40,40,40),PLAYER_HEIGHT_MAX:300},E={ID:"boot"},M={ID:"loading"},P={ID:"intro"},x={ID:"main"},T={ID:"summary"},O={ID:"global"},C=10,R={PREFIX:"T5TT8G#",request:t=>R.PREFIX+t},k={terrain:237};const L={},A={};class F extends s.Scene{constructor(){super({key:E.ID})}create(){this.scene.start(M.ID)}}class U{constructor(t){this.registry=t;for(let e in l)switch(l[e].ID){case l.audioMute.ID:let i="true"===localStorage.getItem(l[e].ID);null===i&&(i=l[e].DEFAULT),t.set(l[e].ID,i);break;case l.audioVolume.ID:let s=localStorage.getItem(l[e].ID);null===s&&(s=l[e].DEFAULT),t.set(l[e].ID,Phaser.Math.RoundTo(parseFloat(s),-2));break;default:t.set(l[e].ID,l[e].DEFAULT)}}}class z extends s.Scene{constructor(){super({key:M.ID})}init(){new U(this.registry)}preload(){let t;for(t in this.load.atlas(n.ID,n.IMAGE,n.DATA),L)this.load.audio(L[t].id,L[t].path);for(t in A)this.load.audio(A[t].id,A[t].path);for(t in h){let e=h[t];this.load.bitmapFont(e.ID,e.IMAGE,e.DATA)}for(t in r){let e=r[t];this.load.spritesheet(e.key,e.path,{frameWidth:e.frameWidth,frameHeight:e.frameHeight})}}create(){for(let t in r){let e=r[t];this.anims.create({key:e.animationKey,frameRate:e.frameRate,frames:this.anims.generateFrameNumbers(e.key,{start:e.start,end:e.end})})}this.scene.start(x.ID),this.scene.launch(O.ID).bringToTop()}}class B extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.bg=t.make.image({key:n.ID,frame:"shared/bg"}),this.topText=t.make.image({key:n.ID,frame:"shared/text_top"}),this.bottomText=t.make.image({key:n.ID,frame:"shared/text_bottom"}),this.add([this.bg,this.topText,this.bottomText])}}function X(t,e){Array.isArray(e)?e.forEach(e=>X(t,e)):s.GameObjects.Container.prototype.isPrototypeOf(t)||Object.getPrototypeOf(t)instanceof s.GameObjects.Container?t.add(e):s.Scene.prototype.isPrototypeOf(t)||Object.getPrototypeOf(t)instanceof s.Scene?t.add.existing(e):console.log("ERROR: ALUtils.js: addAll: parent is not a PhaserScene or PhaserGameObjects.Container.")}function N(t,e,i){t.registry.events.on(`changedata-${e}`,i),t.events.on("shutdown",()=>t.registry.events.off(`changedata-${e}`,i))}function V(t,e,i){t.registry.events.on(e,i),t.events.on("shutdown",()=>t.registry.events.off(e,i))}class j extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.button=t.make.image({key:n.ID,frame:"shared/wide_button"}),this.text=t.make.bitmapText({font:h.gotham_ultra_italic.ID,text:"PLAY",size:100,origin:{x:.54,y:.45}}),((t,e,i=null,a=1.05,n=null)=>{null===i&&(i=e),null===n&&(n=e.scale);let r=null;e.setInteractive({useHandCursor:!0});const h=()=>{r&&r.stop(),r=t.tweens.add({targets:i,duration:350,ease:s.Math.Easing.Bounce.Out,scale:{from:i.scale,to:n}})};e.on(s.Input.Events.POINTER_OVER,()=>{r&&r.stop(),r=t.tweens.add({targets:i,duration:250,ease:s.Math.Easing.Back.Out,scale:{from:i.scale,to:a}})}),e.on(s.Input.Events.POINTER_OUT,h),e.on(s.Input.Events.POINTER_UP,h),e.on(s.Input.Events.POINTER_UP_OUTSIDE,h)})(t,this.button,this),X(this,[this.button,this.text])}}class Z extends s.Scene{constructor(){super({key:P.ID}),this.handlePlayClicked=(t,e)=>{this.playButton.button.input.enabled=!1,this.scene.start(x.ID)},this.handleReflow=()=>{this.containerCentered.setScale(this.cameras.main.height/I),this.containerCentered.setPosition(this.cameras.main.centerX,this.cameras.main.centerY)}}create(){V(this,u,this.handleReflow),this.background=new B(this),this.playButton=new j(this,0,.275*I),this.playButton.button.on(s.Input.Events.POINTER_UP,this.handlePlayClicked),this.containerCentered=this.add.container(this.cameras.main.centerX,this.cameras.main.centerY,[this.background,this.playButton]),this.tweens.timeline({tweens:[{targets:this.background.bg,duration:500,ease:s.Math.Easing.Back.Out,props:{y:{start:-100,to:0},alpha:{start:0,to:1}}},{offset:100,targets:this.background.topText,duration:500,ease:s.Math.Easing.Back.Out,props:{x:{start:-100,to:0},alpha:{start:0,to:1}}},{offset:200,targets:this.background.bottomText,duration:500,ease:s.Math.Easing.Back.Out,props:{x:{start:100,to:0},alpha:{start:0,to:1}}},{offset:300,targets:this.playButton,duration:1e3,ease:s.Math.Easing.Quintic.Out,props:{y:{start:this.playButton.y+100,to:this.playButton.y},alpha:{start:0,to:1}}}]}),this.handleReflow()}}i(1644);var H=i(0),G=i(134),Q=i(58);class q extends Q.a{constructor(t,e=[]){super("000_lights_container",t.babylonScene),this.engine=t,this.lights=[new G.a("001_light_hemispheric",new H.e(1,6,0),this.engine.babylonScene)];const i=this.lights[0];i.groundColor=a.b.FromHexString("#1a3c45"),i.shadowEnabled=!0,i.intensity=1.4,i.parent=this}}var Y=i(6),K=i(38),W=i(106),$=i(11);class J{constructor(t){this.engine=t,this.skybox=Y.a.CreateBox("skyBox",1200,this.engine.babylonScene),this.skyboxMaterial=new K.a("skyBox",this.engine.babylonScene),this.skyboxMaterial.backFaceCulling=!1,this.skyboxMaterial.disableLighting=!0,this.skybox.material=this.skyboxMaterial,this.skybox.infiniteDistance=!0,this.skyboxMaterial.reflectionTexture=new W.a("assets/textures/skybox/skybox",this.engine.babylonScene),this.skyboxMaterial.reflectionTexture.coordinatesMode=$.a.SKYBOX_MODE,this.skybox.renderingGroupId=0,this.engine.babylonScene.environmentTexture=this.skyboxMaterial.reflectionTexture}}var tt=i(13),et=i(19),it=i(311);class st extends it.a{constructor(t,e=null){super("follow-camera",new a.h(s.Utils.Array.GetRandom([-100,100]),20,120),t.babylonScene,e),this.engine=t,this.target=e,this.rotationQuaternion=null,this.radius=30,this.lowerRadiusLimit=20,this.upperRadiusLimit=40,this.cameraAcceleration=.075}}class at{constructor(t="",e="black"){this.loadingUIText=t,this.loadingUIBackgroundColor=e,this.displayLoadingUI=()=>{},this.hideLoadingUI=()=>{}}}var nt=i(41);class rt{constructor(t){this.engine=t,this.initialized=!1,this.init=async()=>await nt.a.AppendAsync("assets/models/","scene.babylon").then(t=>{this.scene=t,Object.keys(o).forEach(e=>{this[e]=t.getMeshByID(o[e].ID),this[e].setParent(null)}),this.initialized=!0,this.scene.activeCamera=this.scene.getCameraByID("follow-camera")})}}class ht{constructor(t,e){this.running=!1,this.main=e,this.canvas=document.getElementById("babylon-canvas"),this.engine=new tt.a(this.canvas,!0,{stencil:!0}),this.engine.loadingScreen=new at,this.phaserScene=t,this.babylonScene=new et.a(this.engine),this.babylonScene.collisionsEnabled=!0,this.babylonScene.fogMode=et.a.FOGMODE_LINEAR,this.babylonScene.fogStart=400,this.babylonScene.fogEnd=600,this.babylonScene.fogColor=a.b.FromHexString("#88b9c3"),this.babylonScene.ambientColor.set(1,1,1),this.camera=new st(this),this.cache=new rt(this),this.time=0,V(t,u,()=>{this.handleResizeEvent()}),this.handleResizeEvent()}handleResizeEvent(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.engine.resize()}runRenderLoop(){this.engine.runRenderLoop(this.render.bind(this))}render(){this.running&&this.babylonScene.render()}}class ot extends Y.a{constructor(t){super("main3d-player",t.babylonScene,null,t.cache.aircraft),this.engine=t,this.handlePlayerPosition=()=>{this.position=this.engine.phaserScene.registry.get(l.playerPosition.ID)},this.handlePlayerRotation=()=>{this.rotation=this.engine.phaserScene.registry.get(l.playerRotation.ID)},this.setEnabled(!0),this.engine.camera.lockedTarget=this,this.rotationQuaternion=null,this.position.y=40,this.ellipsoid=new a.h(10,3,10),this.ellipsoidOffset=a.h.Zero(),this.setParent(null),N(t.phaserScene,l.playerPosition.ID,this.handlePlayerPosition),N(t.phaserScene,l.playerRotation.ID,this.handlePlayerRotation)}}class lt{constructor(t){this.handleA=t=>{this.engine.phaserScene.registry.events.emit(p)},this.handlePointerDown=(t,e)=>{},this.engine=t,["SPACE","CTRL","SHIFT","X","ALT"].forEach(t=>this.addInput(t,this.handleA)),t.phaserScene.input.on(Phaser.Input.Events.POINTER_DOWN,this.handlePointerDown)}addInput(t,e){this.engine.phaserScene.input.keyboard.on(`keydown-${t}`,e)}}var ct=i(82);class ut{constructor(t,e,i){this.name=t,this.options=e,this.scene=i,this._particleDataStride=9,this._particleColorStride=4,this._particleUVStride=4,this._typeSPS=0,this._typeInstance=1,this._subToleranceX=1,this._subToleranceZ=1,this._LODLimits=[],this._initialLOD=1,this._LODValue=1,this._cameraLODCorrection=0,this._LODPositiveX=!0,this._LODNegativeX=!0,this._LODPositiveZ=!0,this._LODNegativeZ=!0,this._inverted=!1,this.shiftFromCamera={x:0,z:0},this._deltaSubX=0,this._deltaSubZ=0,this._refreshEveryFrame=!1,this._useCustomVertexFunction=!1,this._computeNormals=!1,this._datamap=!1,this._uvmap=!1,this._colormap=!1,this._mapSPData=!1,this._colorSPData=!1,this._uvSPData=!1,this._mapInstanceData=!1,this._colorInstanceData=!1,this._precomputeInstances=!0,this._averageSubSizeX=0,this._averageSubSizeZ=0,this._terrainSizeX=0,this._terrainSizeZ=0,this._terrainHalfSizeX=0,this._terrainHalfSizeZ=0,this._centerWorld=a.h.Zero(),this._centerLocal=a.h.Zero(),this._mapSizeX=0,this._mapSizeZ=0,this._isAlwaysVisible=!1,this._precomputeNormalsFromMap=!1,this._v1=a.h.Zero(),this._v2=a.h.Zero(),this._v3=a.h.Zero(),this._v4=a.h.Zero(),this._vAvB=a.h.Zero(),this._vAvC=a.h.Zero(),this._norm=a.h.Zero(),this._bbMin=a.h.Zero(),this._bbMax=a.h.Zero(),this._pos=a.h.Zero(),this._scl=a.h.Zero(),this._quat=a.e.Identity(),this._mat=new Float32Array(16),this._matZero=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]),this._col=new Float32Array(4),this._vertex={position:a.h.Zero(),uvs:a.g.Zero(),color:new a.c(1,1,1,1),lodX:1,lodZ:1,worldPosition:a.h.Zero(),mapIndex:0},this.update=t=>{var e,i=!1,s=!!t,a=this._terrain.position,n=this._terrainCamera.globalPosition,r=this.shiftFromCamera,h=this._terrainHalfSizeX,o=this._terrainHalfSizeZ,l=h+a.x-n.x-r.x,c=o+a.z-n.z-r.z,u=this._subToleranceX,p=this._subToleranceZ,m=this._mod,d=this._cameraLODCorrection;this._cameraLODCorrection=0|this.updateCameraLOD(this._terrainCamera),e=d!=this._cameraLODCorrection;var g=this._initialLOD+this._cameraLODCorrection;g=g>0?g:1,this._LODValue=g;var _=this._averageSubSizeX*u*g,y=this._averageSubSizeZ*p*g,b=0,S=this._deltaSubX,f=this._deltaSubZ;if(Math.abs(l)>_){var v=l>0?-1:1;b=0|Math.abs(l/_),a.x+=_*v*b,S+=u*v*g*b,i=!0}if(Math.abs(c)>y){var D=c>0?-1:1;b=0|Math.abs(c/y),a.z+=y*D*b,f+=p*D*g*b,i=!0}var I=e||s;return(i||I)&&(this._deltaSubX=m(S,this._mapSubX),this._deltaSubZ=m(f,this._mapSubZ),this._updateTerrain(I)),h=this._terrainHalfSizeX,o=this._terrainHalfSizeZ,this.centerLocal.copyFromFloats(h,0,o),this._centerWorld.copyFromFloats(a.x+h,a.y,a.z+o),this},this._updateTerrain=t=>{var e=0,i=0,s=0,n=0,r=this._LODValue,h=r,o=r,l=r,c=this._bbMin,u=this._bbMax,p=this._terrain,m=this._positions,d=this._normals,g=this._colors,_=this._uvs,y=this._mapColors,b=this._mapNormals,S=this._mapData,f=this._mapUVs,v=this._mapSPData,D=this._mapQuads,I=this._spsNbPerType,w=this._SPmapData,E=this._SPcolorData,M=this._SPuvData,P=this._mapInstanceData,x=this._instanceMapData,T=this._instanceColorData,O=this._particleDataStride,C=this._particleColorStride,R=this._particleUVStride,k=this._LODLimits,L=this._terrainSub,A=this._mod,F=this._terrainIdx,U=this._mapSubX,z=this._mapSubZ,B=this._deltaSubX,X=this._deltaSubZ,N=this._datamap,V=this._uvmap,j=this._colormap,Z=this._useCustomVertexFunction,H=this.updateVertex,G=!this._computeNormals,Q=this._LODPositiveX,q=this._LODNegativeX,Y=this._LODPositiveZ,K=this._LODNegativeZ,W=this._mapSizeX,$=this._mapSizeZ,J=this._averageSubSizeX,tt=this._averageSubSizeZ,et=v&&D,it=et&&this._colorSPData,st=et&&this._uvSPData,at=this._typeSPS,nt=this._typeInstance,rt=P&&D,ht=rt&&this._colorInstanceData,ot=this._precomputeInstances,lt=this._sourceMeshes,ut=this._nbAvailableInstancesPerType,pt=this._ComposeToRef,mt=this._CopyArrayValuesFromToRef,dt=this._instanceWM,gt=this._scl,_t=this._pos,yt=this._quat,bt=this._matZero,St=0,ft=0,vt=0,Dt=0,It=0,wt=0,Et=0,Mt=0,Pt=0,xt=0,Tt=0,Ot=0,Ct=0,Rt=0,kt=0,Lt=0,At=0,Ft=0,Ut=0;t&&this.updateTerrainSize(),a.h.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,c),a.h.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,u);var zt=S[0],Bt=S[2],Xt=p.position;if(et)for(var Nt=this._sps,Vt=Nt.particles,jt=this._spsTypeStartIndexes,Zt=this._nbAvailableParticlesPerType,Ht=Nt.nbParticles,Gt=0;Gt<Ht;Gt++)Vt[Gt].isVisible=!1;if(rt)for(var Qt=this._mat,qt=0;qt<lt.length;qt++){if(Ke=(Ye=lt[qt]).worldMatrixInstancedBuffer)for(var Yt=Ye.instances,Kt=0,Wt=0;Wt<Yt.length;Wt++)Ke.set(bt,Kt),Kt+=16}for(var $t=!1,Jt=!1,te=0,ee=0,ie=A(B,U),se=A(X,z),ae=0,ne=0,re=0,he=0,oe=m.length,le=_.length,ce=g.length,ue=1;ue<=L;ue++){for(ae=r,ne=r,St=0;St<k.length;St++)n=L-(s=k[St])-1,(K&&ue<s||Y&&ue>n)&&(ae=St+1+r),(q&&ue<s||Q&&ue>n)&&(ne=St+1+r),l=ae,o=ne;if(e+=l,i+=o,$t||(re=A(B+i,U),Math.abs(re-ie)>o?($t=!0,te=i):ie=re),Jt||(he=A(X+e,z),Math.abs(he-se)>l?(Jt=!0,ee=e):se=he),Jt&&$t)break}i=0,e=0,o=r,l=r;var pe=0;for(ue=0;ue<=L;ue++){for(h=r,St=0;St<k.length;St++)n=L-(s=k[St])-1,(K&&ue<s||Y&&ue>n)&&(h=St+1+r),l=h;pe=A(X+e,z);for(Wt=0;Wt<=L;Wt++){for(h=r,St=0;St<k.length;St++)n=L-(s=k[St])-1,(q&&Wt<s||Q&&Wt>n)&&(h=St+1+r),o=h;if(ft=pe*U+A(B+i,U),Mt=A(X+e,F)*F+A(B+i,F),Et=V?2*ft:2*Mt,wt=j?3*ft:3*Mt,Dt=(vt=N?3*ft:3*Mt)+1,It=vt+2,Tt=2*Pt,Ft=(xt=3*Pt)+1,Ut=xt+2,Ct=Ot=4*Pt,Rt=Ot+1,kt=Ot+2,Lt=Ot+3,Pt+=1,m[At=xt]=J*i,m[Ft]=S[Dt],m[Ut]=tt*e,G&&(d[At]=b[vt],d[Ft]=b[Dt],d[Ut]=b[It]),_[Tt]=f[Et],_[Tt+1]=f[Et+1],j&&(g[Ct]=y[wt],g[Rt]=y[wt+1],g[kt]=y[wt+2]),Jt&&(ee==e||e==ee+1)){var me=(be=A(At-(3*L+3),oe))+1,de=be+2;m[At]=m[be],m[Ft]=m[me],m[Ut]=m[de],G&&(d[At]=d[be],d[Ft]=d[me],d[Ut]=d[de]);var ge=2*(Se=2*L+2);if(e==ee+1){var _e=A(Tt-Se,le);if(_[Tt]=_[_e],_[Tt+1]=_[_e+1],j){var ye=A(Ot-ge,ce);g[Ct]=g[ye],g[Rt]=g[ye+1],g[kt]=g[ye+2]}}}if($t&&(te==i||i==te+1)){var be;me=(be=A(At-3,oe))+1,de=be+2;m[At]=m[be],m[Ft]=m[me],m[Ut]=m[de],G&&(d[At]=d[be],d[Ft]=d[me],d[Ut]=d[de]);var Se=2;ge=4;if(i==te+1){_e=A(Tt-Se,le);if(_[Tt]=_[_e],_[Tt+1]=_[_e+1],j){ye=A(Ot-ge,ce);g[Ct]=g[ye],g[Rt]=g[ye+1],g[kt]=g[ye+2]}}}if(m[At]<c.x&&(c.x=m[At]),m[At]>u.x&&(u.x=m[At]),m[Ft]<c.y&&(c.y=m[Ft]),m[Ft]>u.y&&(u.y=m[Ft]),m[Ut]<c.z&&(c.z=m[Ut]),m[Ut]>u.z&&(u.z=m[Ut]),Z){var fe=this._vertex,ve=fe.position,De=fe.worldPosition,Ie=fe.color,we=fe.uvs;ve.copyFromFloats(m[At],m[Ft],m[Ut]),De.copyFromFloats(S[vt],ve.y,S[It]),fe.lodX=o,fe.lodZ=l,Ie.copyFromFloats(g[Ct],g[Rt],g[kt],g[Lt]),we.copyFromFloats(_[Tt],_[Tt+1]),fe.mapIndex=ft,H(fe,Wt,ue),g[Ct]=Ie.r,g[Rt]=Ie.g,g[kt]=Ie.b,g[Lt]=Ie.a,_[Tt]=we.x,_[Tt+1]=we.y,m[At]=ve.x,m[Ft]=ve.y,m[Ut]=ve.z}if(et&&D[ft]){var Ee=D[ft][at];for(qt=0;qt<Ee.length;qt++){var Me=w[qt],Pe=Ee[qt];if(it)var xe=E[qt];if(st)var Te=M[qt];if(Pe){for(var Oe=jt[qt],Ce=Pe.length,Re=(ii=I[qt]-(ei=Zt[qt]))>0?ii:0,ke=ei<Ce?ei:Ce,Le=0;Le<ke;Le++){var Ae=Pe[Le],Fe=Ae*O,Ue=Vt[Oe+Le+Re],ze=Ue.position,Be=Ue.rotation,Xe=Ue.scaling,Ne=Me[Fe];ze.x=Ne+Math.floor((Xt.x-Ne-zt)/W)*W,ze.y=Me[Fe+1];var Ve=Me[Fe+2];if(ze.z=Ve+Math.floor((Xt.z-Ve-Bt)/$)*$,Be.x=Me[Fe+3],Be.y=Me[Fe+4],Be.z=Me[Fe+5],Xe.x=Me[Fe+6],Xe.y=Me[Fe+7],Xe.z=Me[Fe+8],it){var je=Ae*C,Ze=Ue.color;Ze.r=xe[je],Ze.g=xe[je+1],Ze.b=xe[je+2],Ze.a=xe[je+3]}if(st){var He=Ae*R,Ge=Ue.uvs;Ge.x=Te[He],Ge.y=Te[He+1],Ge.z=Te[He+2],Ge.w=Te[He+3]}Ue.isVisible=!0,Re+=1,ke=(ei-=1)<Ce?ei:Ce}ei=ei>0?ei:0,Zt[qt]=ei}}}if(rt&&D[ft]){Ee=D[ft][nt];var Qe=this._colorBuffers,qe=this._col;for(qt=0;qt<Ee.length;qt++){Yt=(Ye=this._sourceMeshes[qt]).instances;var Ye,Ke=Ye.worldMatrixInstancedBuffer,We=(Me=x[qt],Ee[qt]),$e=dt[qt];if(ht)var Je=T[qt],ti=Qe[qt];if(We&&Ke){for(var ei,ii,si=We.length,ai=(Re=(ii=Yt.length-(ei=ut[qt]))>0?ii:0,ke=ei<si?ei:si,0);ai<ke;ai++){var ni=We[ai],ri=(Fe=ni*O,ai+Re),hi=16*ri;if(ot)mt($e,16*ni,16,Qt);else{Ne=Me[Fe];var oi=Me[Fe+1];Ve=Me[Fe+2];Ne+=Math.floor((Xt.x-Ne-zt)/W)*W,Ve+=Math.floor((Xt.z-Ve-Bt)/$)*$,_t.copyFromFloats(Ne,oi,Ve),Ne=Me[Fe+3],oi=Me[Fe+4],Ve=Me[Fe+5],a.e.RotationYawPitchRollToRef(oi,Ne,Ve,yt),gt.copyFromFloats(Me[Fe+6],Me[Fe+7],Me[Fe+8]),pt(gt,yt,_t,Qt)}if(Ke.set(Qt,hi),T){je=ni*C;var li=4*ri;qe[0]=Je[je],qe[1]=Je[je+1],qe[2]=Je[je+2],qe[3]=Je[je+3],ti.updateDirectly(qe,li)}Re+=1,ke=(ei-=1)<si?ei:si}ei=ei>0?ei:0,this._nbAvailableInstancesPerType[qt]=ei}}}i+=o}$t&&te+1==i&&($t=!1),Jt&&ee+1==e&&(Jt=!1),e+=l,i=0}if(et){Nt.setParticles();for(var ci=0;ci<Zt.length;ci++)Zt[ci]=I[ci]}if(rt&&ut)for(ci=0;ci<ut.length;ci++)ut[ci]=this._sourceMeshes[ci].instances.length;p.updateVerticesData(ct.g.PositionKind,m,!1,!1),this._computeNormals&&ct.h.ComputeNormals(m,this._indices,d),p.updateVerticesData(ct.g.NormalKind,d,!1,!1),p.updateVerticesData(ct.g.UVKind,_,!1,!1),p.updateVerticesData(ct.g.ColorKind,g,!1,!1),p._boundingInfo.reConstruct(c,u,p._worldMatrix)},this._mod=(t,e)=>(t%e+e)%e,this.updateTerrainSize=()=>{for(var t=this._terrainSub,e=0,i=0,s=this._LODValue,a=s+1,n=0,r=0,h=this._LODLimits,o=this._averageSubSizeX,l=this._averageSubSizeZ,c=0;c<h.length;c++)a=s+c+1,i=c>=h.length-1?0:h[c+1],n+=o*a*(e=2*(h[c]-i)),r+=l*a*e,t-=e;return n+=t*o*s,r+=t*l*s,this._terrainSizeX=n,this._terrainSizeZ=r,this._terrainHalfSizeX=.5*n,this._terrainHalfSizeZ=.5*r,this},this.getHeightFromMap=(t,e,i)=>this._GetHeightFromMap(t,e,this._mapData,this._mapSubX,this._mapSubZ,this._mapSizeX,this._mapSizeZ,i,this._inverted),this.GetHeightFromMap=(t,e,i,s,a,n,r=!1)=>{var h=Math.abs(i[3*(s-1)]-i[0]),o=Math.abs(i[(a-1)*s*3+2]-i[2]);return this._GetHeightFromMap(t,e,i,s,a,h,o,n,r)},this._GetHeightFromMap=(t,e,i,s,n,r,h,o,l)=>{var c=i[0],u=i[2];t-=Math.floor((t-c)/r)*r,e-=Math.floor((e-u)/h)*h;var p=Math.floor((t-c)*s/r),m=Math.floor((e-u)*n/h),d=(p+1)%s,g=(m+1)%n,_=3*(m*s+p),y=3*(m*s+d),b=3*(g*s+p),S=3*(g*s+d),f=this._v1,v=this._v2,D=this._v3,I=this._v4;f.copyFromFloats(i[_],i[_+1],i[_+2]),v.copyFromFloats(i[y],i[y+1],i[y+2]),D.copyFromFloats(i[b],i[b+1],i[b+2]),I.copyFromFloats(i[S],i[S+1],i[S+2]);var w,E,M,P=this._vAvB,x=this._vAvC,T=this._norm,O=f,C=I.x-f.x,R=I.z-f.z;if(0==C||0==R)return f.y;var k=R/C;e<k*t+(f.z-k*f.x)?(w=I,E=v,M=O):(E=I,M=w=D),w.subtractToRef(O,P),E.subtractToRef(O,x),a.h.CrossToRef(P,x,T),T.normalize(),l&&T.scaleInPlace(-1),o&&o.normal&&o.normal.copyFrom(T);var L=-(T.x*M.x+T.y*M.y+T.z*M.z),A=M.y;return 0!=T.y&&(A=-(T.x*t+T.z*e+L)/T.y),A},this.ComputeNormalsFromMapToRef=(t,e,i,s,n)=>{var r=[],h={normal:a.h.Zero()},o={normal:a.h.Zero()},l=h.normal,c=o.normal,u=e*(i-1),p=0;for(p=0;p<u;p++)r.push(p+1,p+e,p),r.push(p+e,p+1,p+e+1);ct.h.ComputeNormals(t,r,s);var m=3*(e-1),d=0,g=0,_=this.GetHeightFromMap;for(p=0;p<i;p++)g=(d=p*e*3)+m,_(t[d],t[d+2],t,e,i,h),_(t[g],t[g+2],t,e,i,o),l.addInPlace(c).scaleInPlace(.5),s[d]=l.x,s[d+1]=l.y,s[d+2]=l.z,s[g]=l.x,s[g+1]=l.y,s[g+2]=l.z;if(n)for(p=0;p<s.length;p++)s[p]=-s[p]},this.computeNormalsFromMap=()=>(this.ComputeNormalsFromMapToRef(this._mapData,this._mapSubX,this._mapSubZ,this._mapNormals,this._inverted),this),this.contains=(t,e)=>{var i=this._positions,s=this.mesh.position,a=this._terrainIdx;return!(t<i[0]+s.x||t>i[3*a]+s.x)&&!(e<i[2]+s.z||e>i[3*a*a+2]+s.z)},this.createUVMap=()=>(this.mapUVs=this.CreateUVMap(this._mapSubX,this._mapSubZ),this),this.updateVertex=(t,e,i)=>{},this.updateCameraLOD=t=>0,this.beforeUpdate=t=>{},this.afterUpdate=t=>{},this._terrainSub=this.options.terrainSub||60,this._mapData=e.mapData,this._terrainIdx=this._terrainSub+1,this._mapSubX=e.mapSubX||this._terrainIdx,this._mapSubZ=e.mapSubZ||this._terrainIdx,this._mapUVs=e.mapUVs,this._mapColors=e.mapColors,this._terrainCamera=e.camera||i.activeCamera,this._inverted=e.invertSide,this._SPmapData=e.SPmapData,this._SPcolorData=e.SPcolorData,this._SPuvData=e.SPuvData,this._sps=e.sps,this._instanceMapData=e.instanceMapData,this._instanceColorData=e.instanceColorData,this._sourceMeshes=e.sourceMeshes,this._precomputeInstances=e.precomputeInstances||e.precomputeInstances,this._terrainSub=e.terrainSub||60,this._mapData=e.mapData,this._terrainIdx=this._terrainSub+1,this._mapSubX=e.mapSubX||this._terrainIdx,this._mapSubZ=e.mapSubZ||this._terrainIdx,this._mapUVs=e.mapUVs,this._mapColors=e.mapColors,this._terrainCamera=e.camera||i.activeCamera,this._inverted=e.invertSide,this._SPmapData=e.SPmapData,this._SPcolorData=e.SPcolorData,this._SPuvData=e.SPuvData,this._sps=e.sps,this._datamap=!!this._mapData,this._uvmap=!!this._mapUVs,this._colormap=!!this._mapColors,this._mapSPData=!!this._SPmapData,this._colorSPData=!(!this._mapSPData||!this._SPcolorData),this._uvSPData=!(!this._mapSPData||!this._SPuvData),this._mapData=this._datamap?this._mapData:new Float32Array(this._terrainIdx*this._terrainIdx*3),this._mapUVs=this._uvmap?this._mapUVs:new Float32Array(this._terrainIdx*this._terrainIdx*2),this._datamap?this._mapNormals=this.options.mapNormals||new Float32Array(this._mapSubX*this._mapSubZ*3):this._mapNormals=new Float32Array(this._terrainIdx*this._terrainIdx*3),this._mapQuads=[];var s,n,r,h=0,o=0,l=0,c=0,u=0,p=0,m=0,d=0,g=this._terrainIdx+1,_=[],y=[],b=[],S=this._mapData,f=this._mapColors,v=this._mapUVs,D=[];this._nbAvailableParticlesPerType=D;for(var I=0;I<=this._terrainSub;I++){r=[];for(var w=0;w<=this._terrainSub;w++)o=3*(h=this._mod(3*I,this._mapSubZ)*this._mapSubX+this._mod(3*w,this._mapSubX)),l=3*h,c=2*h,u=I*this._terrainIdx+w,this._datamap?p=S[o+1]:(p=0,S[3*u]=w,S[3*u+1]=p,S[3*u+2]=I),r.push(new a.h(w,p,I)),s=this._colormap?new a.c(f[l],f[l+1],f[l+2],1):new a.c(1,1,1,1),y.push(s),this._uvmap?n=new a.g(v[c],v[c+1]):(m=1-Math.abs(1-2*w/g),d=1-Math.abs(1-2*I/g),v[2*u]=m,v[2*u+1]=d,n=new a.g(m,d)),b.push(n);_.push(r)}this._mapSizeX=Math.abs(S[3*(this._mapSubX-1)]-S[0]),this._mapSizeZ=Math.abs(S[(this._mapSubZ-1)*this._mapSubX*3+2]-S[2]),this._averageSubSizeX=this._mapSizeX/this._mapSubX,this._averageSubSizeZ=this._mapSizeZ/this._mapSubZ;var E={pathArray:_,sideOrientation:e.invertSide?Y.a.FRONTSIDE:Y.a.BACKSIDE,colors:y,uvs:b,updatable:!0};this._terrain=ct.c.CreateRibbon("terrain",E,this.scene),this._indices=this._terrain.getIndices(),this._positions=this._terrain.getVerticesData(ct.g.PositionKind),this._normals=this._terrain.getVerticesData(ct.g.NormalKind),this._uvs=this._terrain.getVerticesData(ct.g.UVKind),this._colors=this._terrain.getVerticesData(ct.g.ColorKind),this.computeNormalsFromMap(),this.update(!0),this._terrain.position.x=this._terrainCamera.globalPosition.x-this._terrainHalfSizeX+this.shiftFromCamera.x,this._terrain.position.z=this._terrainCamera.globalPosition.z-this._terrainHalfSizeZ+this.shiftFromCamera.z;var M=(this._terrain.position.x-S[0])/this._averageSubSizeX,P=(this._terrain.position.z-S[2])/this._averageSubSizeZ;this._deltaSubX=M>0?Math.floor(M):Math.ceil(M),this._deltaSubZ=P>0?Math.floor(P):Math.ceil(P),this.scene.onBeforeRenderObservable.add(()=>{var t=this._refreshEveryFrame;this.beforeUpdate(t),this.update(t),this.afterUpdate(t)});var x=this._SPmapData,T=this._instanceMapData,O=this._particleDataStride,C=this._typeSPS,R=this._typeInstance,k=this._mapSizeX,L=this._mapSizeZ,A=this._mapSubX,F=this._mapSubZ,U=this._mapQuads;if(this._mapSPData){for(var z=S[0],B=S[2],X=0;X<x.length;X++)for(var N=(rt=x[X]).length/O|0,V=0;V<N;V++){var j=rt[ot=V*O],Z=rt[ot+2];j-=Math.floor((j-z)/k)*k,Z-=Math.floor((Z-B)/L)*L;var H=Math.floor((j-z)*A/k);void 0===U[gt=Math.floor((Z-B)*F/L)*A+H]&&(U[gt]=[],U[gt][C]=[]),void 0===U[gt][C][X]&&(U[gt][C][X]=[]),U[gt][C][X].push(V)}var G=this._sps;G.computeBoundingBox=!0,G.isAlwaysVisible=!0,this._colorSPData&&(G.computeParticleColor=!0),this._uvSPData&&(G.computeParticleTexture=!0);var Q=[];this._spsTypeStartIndexes=Q;var q=[];this._spsNbPerType=q;var K=G.nbParticles,W=G.particles,$=0;Q.push($),D.push(0);for(var J=1,tt=1;tt<K;tt++)W[tt].isVisible=!1,$!=W[tt].shapeId&&($++,Q.push(tt),q.push(J),D.push(J),J=0),J++;q.push(J)}if(this._mapInstanceData){z=S[0],B=S[2];this._colorBuffers=[],this._instanceWM=[];var et=this._pos,it=this._scl,st=this._mat,at=this._quat,nt=this._ComposeToRef;for(X=0;X<T.length;X++){var rt;N=(rt=T[X]).length/O|0;if(this._precomputeInstances){this._instanceWM[X]=new Float32Array(16*N);var ht=this._instanceWM[X]}for(V=0;V<N;V++){j=rt[ot=V*O];var ot,lt=rt[ot+1];Z=rt[ot+2];if(this._precomputeInstances){et.copyFromFloats(j,lt,Z);var ut=rt[ot+3],pt=rt[ot+4],mt=rt[ot+5];a.e.RotationYawPitchRollToRef(pt,ut,mt,at),it.copyFromFloats(rt[ot+6],rt[ot+7],rt[ot+8]),nt(it,at,et,st);var dt=16*V;ht.set(st,dt)}j-=Math.floor((j-z)/k)*k,Z-=Math.floor((Z-B)/L)*L;var gt;H=Math.floor((j-z)*A/k);void 0===U[gt=Math.floor((Z-B)*F/L)*A+H]&&(U[gt]=[],U[gt][R]=[]),void 0===U[gt][R]&&(U[gt][R]=[]),void 0===U[gt][R][X]&&(U[gt][R][X]=[]),U[gt][R][X].push(V)}}var _t=[];this._nbAvailableInstancesPerType=_t;var yt=this._sourceMeshes.length,bt=this.scene.getEngine();for(X=0;X<yt;X++){var St=this._sourceMeshes[X];St.alwaysSelectAsActiveMesh=!0;var ft=St.instances.length;_t[X]=ft,St.manualUpdateOfWorldMatrixInstancedBuffer=!0;for(w=0;w<St.instances.length;w++){var vt=St.instances[w];vt.freezeWorldMatrix(),vt.alwaysSelectAsActiveMesh=!0,vt.doNotSyncBoundingInfo=!0}if(this._colorInstanceData){for(var Dt=new Float32Array(4*(St.instances.length+1)),It=0;It<Dt.length;It++)Dt[It]=1;var wt=new ct.g(bt,Dt,ct.g.ColorKind,!0,!1,4,!0);St.setVerticesBuffer(wt),this._colorBuffers.push(wt)}}}this.update(!0)}CreateMapFromHeightMap(t,e,i){var s=e.subX||100,a=e.subZ||100,n=new Float32Array(s*a*3);return this.CreateMapFromHeightMapToRef(t,e,n,i),n}CreateMapFromHeightMapToRef(t,e,i,s){var n=e.width||300,r=e.height||300,h=e.subX||100,o=e.subZ||100,l=e.minHeight||0,c=e.maxHeight||10,u=e.offsetX||0,p=e.offsetZ||0,m=e.colorFilter||new a.b(.3,.59,.11),d=e.onReady;ct.e.LoadImage(t,(function(t){var e=document.createElement("canvas"),s=e.getContext("2d"),a=t.width,g=t.height;e.width=a,e.height=g,s.drawImage(t,0,0);for(var _=s.getImageData(0,0,a,g).data,y=0,b=0,S=0,f=0;f<o;f++)for(var v=0;v<h;v++){var D=4*((((y=v*n/h-.5*n)+.5*n)/n*(a-1)|0)+(g-1-((S=f*r/o-.5*r)+.5*r)/r*(g-1)|0)*a),I=(_[D]*m.r+_[D+1]*m.g+_[D+2]*m.b)/255;b=l+(c-l)*I;var w=3*(f*h+v);i[w]=y+u,i[w+1]=b,i[w+2]=S+p}d&&d(i,h,o)}),(function(){}),s.offlineProvider)}CreateUVMapToRef(t,e,i){for(var s=0;s<e;s++)for(var a=0;a<t;a++)i[2*(s*t+a)]=a/(t-1),i[2*(s*t+a)+1]=s/(e-1)}CreateUVMap(t,e){var i=new Float32Array(t*e*2);return this.CreateUVMapToRef(t,e,i),i}_ComposeToRef(t,e,i,s){var a=e.x,n=e.y,r=e.z,h=e.w,o=a+a,l=n+n,c=r+r,u=a*o,p=a*l,m=a*c,d=n*l,g=n*c,_=r*c,y=h*o,b=h*l,S=h*c,f=t.x,v=t.y,D=t.z;s[0]=(1-(d+_))*f,s[1]=(p+S)*f,s[2]=(m-b)*f,s[3]=0,s[4]=(p-S)*v,s[5]=(1-(u+_))*v,s[6]=(g+y)*v,s[7]=0,s[8]=(m+b)*D,s[9]=(g-y)*D,s[10]=(1-(u+d))*D,s[11]=0,s[12]=i.x,s[13]=i.y,s[14]=i.z,s[15]=1}_CopyArrayValuesFromToRef(t,e,i,s){for(var a=0;a<i;a++)s[a]=t[e+a]}get refreshEveryFrame(){return this._refreshEveryFrame}set refreshEveryFrame(t){this._refreshEveryFrame=t}get mesh(){return this._terrain}get camera(){return this._terrainCamera}set camera(t){this._terrainCamera=t}get subToleranceX(){return this._subToleranceX}set subToleranceX(t){this._subToleranceX=t>0?t:1}get subToleranceZ(){return this._subToleranceZ}set subToleranceZ(t){this.subToleranceZ=t>0?t:1}get initialLOD(){return this._initialLOD}set initialLOD(t){this._initialLOD=t>0?t:1}get LODValue(){return this._LODValue}get cameraLODCorrection(){return this._cameraLODCorrection}set cameraLODCorrection(t){this._cameraLODCorrection=t>0?t:0}get LODPositiveX(){return this._LODPositiveX}set LODPositiveX(t){this._LODPositiveX=t}get LODNegativeX(){return this._LODNegativeX}set LODNegativeX(t){this._LODNegativeX=t}get LODPositiveZ(){return this._LODPositiveZ}set LODPositiveZ(t){this._LODPositiveZ=t}get averageSubSizeX(){return this._averageSubSizeX}get averageSubSizeZ(){return this._averageSubSizeZ}get terrainSizeX(){return this._terrainSizeX}get terrainHalfSizeX(){return this.terrainHalfSizeX}get terrainSizeZ(){return this._terrainSizeZ}get terrainHalfSize(){return this._terrainHalfSizeZ}get centerLocal(){return this._centerLocal}get centerWorld(){return this._centerWorld}get LODLimits(){return this._LODLimits}set LODLimits(t){t.sort((function(t,e){return e-t})),this._LODLimits=t}get mapData(){return this._mapData}set mapData(t){this._mapData=t,this._datamap=!0;var e=this._mapSubX,i=this._mapSubZ;this._mapSizeX=Math.abs(t[3*(e-1)]-t[0]),this._mapSizeZ=Math.abs(t[(i-1)*e*3+2]-t[2]),this._averageSubSizeX=this._mapSizeX/e,this._averageSubSizeZ=this._mapSizeZ/i,this._precomputeNormalsFromMap&&this.computeNormalsFromMap(),this.update(!0)}get mapSubX(){return this._mapSubX}set mapSubX(t){this._mapSubX=t}get mapSubZ(){return this._mapSubZ}set mapSubZ(t){this._mapSubZ=t}get mapColors(){return this._mapColors}set mapColors(t){this._colorMap=!0,this._mapColors=t}get mapUVs(){return this._mapUVs}set mapUVs(t){this._uvmap=!0,this._mapUVs=t}get mapNormals(){return this._mapNormals}set mapNormals(t){this._mapNormals=t}get computeNormals(){return this._computeNormals}set computeNormals(t){this._computeNormals=t}get useCustomVertexFunction(){return this._useCustomVertexFunction}set useCustomVertexFunction(t){this._useCustomVertexFunction=t}get isAlwaysVisible(){return this._isAlwaysVisible}set isAlwaysVisible(t){this.mesh.alwaysSelectAsActiveMesh=t,this._isAlwaysVisible=t}get precomputeNormalsFromMap(){return this._precomputeNormalsFromMap}set precomputeNormalsFromMap(t){this._precomputeNormalsFromMap=t}}class pt{constructor(t,e,i){this.x=t,this.y=e,this.z=i}dot2(t,e){return this.x*t+this.y*e}dot3(t,e,i){return this.x*t+this.y*e+this.z*i}}let mt=[new pt(1,1,0),new pt(-1,1,0),new pt(1,-1,0),new pt(-1,-1,0),new pt(1,0,1),new pt(-1,0,1),new pt(1,0,-1),new pt(-1,0,-1),new pt(0,1,1),new pt(0,-1,1),new pt(0,1,-1),new pt(0,-1,-1)],dt=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],gt=new Array(512),_t=new Array(512),yt=.5*(Math.sqrt(3)-1),bt=(3-Math.sqrt(3))/6;(t=>{t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(var e=0;e<256;e++){var i;i=1&e?dt[e]^255&t:dt[e]^t>>8&255,gt[e]=gt[e+256]=i,_t[e]=_t[e+256]=mt[i%12]}})(0);const St=(t,e)=>{var i,s,a=(t+e)*yt,n=Math.floor(t+a),r=Math.floor(e+a),h=(n+r)*bt,o=t-n+h,l=e-r+h;o>l?(i=1,s=0):(i=0,s=1);var c=o-i+bt,u=l-s+bt,p=o-1+2*bt,m=l-1+2*bt,d=_t[(n&=255)+gt[r&=255]],g=_t[n+i+gt[r+s]],_=_t[n+1+gt[r+1]],y=.5-o*o-l*l,b=.5-c*c-u*u,S=.5-p*p-m*m;return 70*((y<0?0:(y*=y)*y*d.dot2(o,l))+(b<0?0:(b*=b)*b*g.dot2(c,u))+(S<0?0:(S*=S)*S*_.dot2(p,m)))};var ft=i(723);class vt{constructor(t){this.engine=t,this.mapSubX=75,this.mapSubZ=75,this.terrainSub=256,this.seed=.3,this.noiseScale=.02,this.elevationScale=40,this.tileScale=10;let e=new Float32Array(this.mapSubX*this.mapSubZ*3);var i=[];let s=0;for(var a=0;a<this.mapSubZ;a++){for(var n=[],r=0;r<this.mapSubX;r++){s++;var h=(r-.5*this.mapSubX)*this.tileScale,o=(a-.5*this.mapSubZ)*this.tileScale;let t=this.remap(Math.sin(s/50),-1,1,0,1);t=this.smoothstep(.3,.75,t);var l=t*(this.fbm2(h,o)*this.elevationScale)-5;e[3*(a*this.mapSubX+r)]=h,e[3*(a*this.mapSubX+r)+1]=l,e[3*(a*this.mapSubX+r)+2]=o,n.push(new ct.f(h,l,o))}i.push(n)}this.terrain=new ut("terrain",{mapData:e,mapSubX:this.mapSubX,mapSubZ:this.mapSubZ,terrainSub:this.terrainSub,particleDataStride:1},t.babylonScene),this.terrain.updateCameraLOD=function(t){return Math.abs(t.globalPosition.y/128|0)};var c=new ft.a("triplanar",t.babylonScene);c.diffuseTextureY=new ct.d("./assets/textures/mountain.jpg",t.babylonScene),c.diffuseTextureX=new ct.d("./assets/textures/grass.png",t.babylonScene),c.diffuseTextureZ=new ct.d("./assets/textures/snow.jpg",t.babylonScene),c.tileSize=32,c.specularColor=ct.a.FromHexString("#d7eeed"),this.material=c,this.terrain.mesh.material=this.material}fbm(t,e){let i=0,s=0,a=1,n=1;t/=10,e/=10;for(var r=0;r<5;++r)i+=St(t*n,e*n)*a,s+=a,a*=.5,n*=2;return i/s}fbm2(t,e){let i=0,s=.5,a=0;t/=75,e/=75;for(var n=0;n<5;++n)i+=St(t,e)*s,a+=s,s*=.5,t*=2,e*=2;return i}remap(t,e,i,s,a){return s+(t-e)*(a-s)/(i-e)}smoothstep(t,e,i){var s=Math.max(0,Math.min(1,(i-t)/(e-t)));return s*s*(3-2*s)}}var Dt=i(319);class It{constructor(t){this.engine=t,this.init=async()=>{const t=[];for(let e in k)t.push(this.loadMaterial(k[e],e));return await Promise.all(t).then(()=>{this.engine.phaserScene.registry.events.emit(c)})},this.loadMaterial=(t,e)=>new Promise(i=>{Dt.a.ParseFromSnippetAsync(R.request(t),this.engine.babylonScene,"assets/models/").then(t=>{this[e]=t,i()})})}}class wt extends Q.a{constructor(t="projectile",e,i){super(t,e),this.original=i,this.mesh=i.clone(`${t}-mesh`,this),this.parent=null}}class Et extends Array{constructor(t,e="clone-",i,n=10){super(n),this.engine=t,this.name=e,this.original=i,this.count=n,this.unavailable=[],this.timeRefireMin=100,this.timeLastShot=0,this.firing=!1,this.requestItem=()=>{if(this.length<0)return null;const t=this.pop();return this.unavailable.push(t),t},this.recycleItem=t=>{const e=this.unavailable.indexOf(t);-1===e&&console.log("ERROR: BabylonMeshPool.ts: recycleItem: Item is not in unavailable pool! item:",t,", this.name:",this.name,", unavailable length:",this.unavailable.length),this.unavailable.splice(e,1)[0],t.setEnabled(!1),t.parent=null,this.push(t)},this.requestShoot=()=>{if(this.engine.phaserScene.time.now<this.timeLastShot+this.timeRefireMin)return;this.timeLastShot=this.engine.phaserScene.time.now;const t=this.requestItem();t?(t.position.copyFrom(this.engine.main.player.position.add(this.engine.main.player.forward.multiply(w.PROJECTILE_FRONT_MULTIPLIER))),t.rotation.copyFrom(this.engine.main.player.rotation),t.scalar=0,t.startTime=this.engine.phaserScene.time.now,t.setEnabled(!0),this.engine.phaserScene.tweens.timeline({targets:t,tweens:[{duration:w.PROJECTILE_DURATION,ease:s.Math.Easing.Linear.Linear,props:{scalar:1}}],onUpdate:(e,i)=>{const s=(this.engine.phaserScene.time.now-t.startTime)*w.PROJECTILE_SPEED;t.position=t.position.add(t.forward.multiply(new a.h(s,s,s)))},onComplete:(e,i)=>{this.recycleItem(t)}})):console.log("Main3DProjectiles.ts: No items left!")};for(let e=0;e<n;e++)this.push(new wt(`${this.name}${e}`,t.babylonScene,i.clone()));this.forEach(t=>t.setEnabled(!1))}}class Mt extends Y.a{constructor(t="objective",e,i){super(t,e,null,i),this.original=i,this.fadeInOutBehavior=new ct.b,this.fadeInOutBehavior.fadeInTime=500,this.fadeInOutBehavior.attach(this),this.fadeInOutBehavior.fadeIn(!0),this.setParent(null),this.setEnabled(!0)}}class Pt extends Array{constructor(t,e="clone-",i,s=10){super(s),this.engine=t,this.name=e,this.original=i,this.count=s,this.unavailable=[],this.lastPosition=a.h.Zero(),this.lastRotation=a.h.Forward(),this.handlePlayerPosition=(t,e)=>{this.unavailable.forEach(t=>{if(a.h.Distance(e,t.position)<20){t.fadeInOutBehavior.fadeIn(!1),this.recycleItem(t,t.fadeInOutBehavior.fadeInTime);let e=w.SCORE_OBJECTIVE_TOUCH_MAX*this.engine.phaserScene.registry.get(l.playerMultiplier.ID);this.engine.phaserScene.registry.events.emit(S,e),this.engine.phaserScene.registry.events.emit(f,e,"OBJECTIVE!"),this.engine.phaserScene.registry.events.emit(v,1)}})},this.requestItem=()=>{if(this.length<0)return null;const t=this.pop();return this.unavailable.push(t),t},this.recycleItem=(t,e=0)=>{const i=this.unavailable.indexOf(t);-1===i&&console.log("ERROR: Main3DObjectives.ts: recycleItem: Item is not in unavailable pool! item:",t,", this.name:",this.name,", unavailable length:",this.unavailable.length),this.unavailable.splice(i,1)[0],this.engine.phaserScene.time.addEvent({delay:e,callback:()=>{t.setEnabled(!1),t.parent=null,this.push(t)}})},this.requestSpawn=()=>{const t=this.requestItem();if(!t)return null;t.setEnabled(!0)};for(let e=0;e<s;e++)this.push(new Mt(`${this.name}${e}`,t.babylonScene,i.clone()));this.forEach(t=>t.setEnabled(!1));const n=[];for(let t=0;t<s;t++)n.push(new a.h(50*Math.sin(.748*t)+t-.5*s,50*Math.sin(.5*t)+130+50*Math.cos(.2312*(t+2)),130*t));this.path=new a.d(n);const r=this.path.getNormals(),h=this.path.getTangents(),o=this.path.getBinormals(),c=this.path.getCurve();for(let t=1,e=c.length-1;t<e;t++){let e=this.requestItem();e.position.copyFrom(c[t]),e.rotationQuaternion=a.e.RotationQuaternionFromAxis(o[t],h[t],r[t]),e.setEnabled(!0)}this.engine.phaserScene.registry.set(l.playerPosition.ID,c[0]),this.engine.phaserScene.registry.set(l.playerRotation.ID,a.h.RotationFromAxis(r[0],o[0],h[0])),N(this.engine.phaserScene,l.playerPosition.ID,this.handlePlayerPosition)}}class xt{constructor(t){this.phaserScene=t,this.handleSummaryReplayRequested=()=>{this.engine.engine.dispose()},this.loadAssets=async()=>{this.skybox=new J(this.engine),this.engine.running=!0,this.lights=new q(this.engine),this.engine.runRenderLoop(),this.commonInput=new lt(this.engine),this.materials=new It(this.engine),await this.materials.init(),this.terrain=new vt(this.engine),this.handleProgress(.25,1,5),window.engine=this.engine,window.scene=this.engine.babylonScene,window.phaserCanvas=this.engine.phaserScene.sys.canvas,this.engine.cache.initialized||await this.engine.cache.init(),this.player=new ot(this.engine),this.engine.phaserScene.registry.events.emit(y,.5,1,2),this.projectiles=new Et(this.engine,"projectile-",this.engine.cache.projectile,100),this.objectives=new Pt(this.engine,"objectives-",this.engine.cache.objective,200)},this.handleProgress=(t,e,i)=>{this.engine.phaserScene.registry.events.emit(y,.5*t+.5,.5*e+.5*i,i)},this.initScene=async()=>{},this.handleLoaded=t=>{},this.allProgress=(t,e)=>{const i=t.length||0;let s=0;return e(s),t.forEach(t=>{t.then(()=>{e(++s/i,s,i)})}),Promise.all(t)},this.engine=new ht(t,this),this.phaserScene.registry.events.once(m,this.handleSummaryReplayRequested)}}class Tt extends s.GameObjects.Image{constructor(t){super(t,0,0,n.ID,"game/crash"),this.handleCrashed=()=>{this.crashTimeline&&this.crashTimeline.isPlaying||(this.angle=s.Math.Between(-10,10),this.crashTimeline=this.scene.tweens.timeline({targets:this,onComplete:()=>{this.crashTimeline=null},tweens:[{duration:200,ease:s.Math.Easing.Quintic.Out,props:{alpha:{start:0,to:1}}},{offset:0,duration:400,ease:s.Math.Easing.Elastic.Out,easeParams:[5],props:{scale:{start:.8,to:1}}},{offset:300,duration:350,ease:s.Math.Easing.Quadratic.In,props:{alpha:{from:1,to:0}}}]}))},this.alpha=0,V(t,b,this.handleCrashed)}}class Ot extends s.GameObjects.Container{constructor(t){super(t)}}class Ct extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.text=t.make.bitmapText({text:"",font:h.gotham_ultra_italic.ID,size:64}).setOrigin(.5).setTint(16776960).setCenterAlign(),this.add(this.text)}}class Rt extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.availablePool=[],this.requestBurst=(t=0,e=null,i=null)=>{if(this.availablePool.length<=0)return void console.log("MainUiScoreFloaterPool.ts: requestBurst: Ran out of score floaters, maybe increase the max...");const a=this.availablePool.pop();a.text.text=`$${(~~t).toLocaleString()}`,e&&(a.text.text=`${e}\n${a.text.text}`),i&&(a.text.text=`${a.text.text}\n${i}`),a.text.setTint(s.Utils.Array.GetRandom([3341079,1571714,1571795,1557499,1542139])),a.alpha=0,a.visible=!0;const n=s.Math.Between(450,700);this.scene.tweens.timeline({targets:a,tweens:[{duration:n,ease:s.Utils.Array.GetRandom([s.Math.Easing.Quadratic.Out,s.Math.Easing.Quintic.Out]),props:{x:{start:0,to:s.Math.Between(-50,50)}}},{offset:0,duration:.9*n,ease:s.Utils.Array.GetRandom([s.Math.Easing.Quadratic.Out,s.Math.Easing.Quintic.Out,s.Math.Easing.Back.Out]),props:{y:{start:0,to:s.Math.Between(-150,-250)}}},{offset:0,duration:.35*n,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:{start:0,to:1}}},{offset:.7*n,duration:.3*n,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:{from:1,to:0}}}],onComplete:()=>{this.availablePool.push(a),a.visible=!1,a.alpha=0}})};for(let e=0;e<C;e++){let e=new Ct(t);e.alpha=0,e.visible=!1,this.add(e),this.availablePool.push(e)}V(t,f,this.requestBurst)}}class kt extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.targetValue=0,this.handleLoadIncrement=(t,e,i)=>{this.targetValueTween&&this.targetValueTween.isPlaying&&this.targetValueTween.stop(),this.targetValueTween=this.scene.tweens.add({targets:this,duration:1e4,ease:s.Math.Easing.Quadratic.InOut,targetValue:{start:this.targetValue,to:t},onUpdate:()=>{this.requestText(this.targetValue)}})},this.requestText=(t=0)=>{this.text.text=`Loading...\n${(100*t).toFixed(0)}%`},this.requestCompleted=()=>{this.targetValueTween.stop(),this.scene.tweens.timeline({targets:this,tweens:[{duration:150,ease:s.Math.Easing.Quintic.Out,props:{targetValue:1}},{duration:1500,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:0}}],onUpdate:()=>{this.requestText(this.targetValue)},onComplete:()=>{this.destroy()}})},this.bg=t.add.graphics(),this.bg.fillStyle(0,1),this.bg.fillRect(-1e4,-1e4,2e4,2e4),this.text=t.add.bitmapText(0,0,h.gotham_ultra_italic.ID,"Loading...",72,1).setOrigin(.5),X(this,[this.bg,this.text]),V(t,y,this.handleLoadIncrement)}}class Lt extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.handleMultiplierUpdated=(t,e)=>{this.titleText.text=`SCORE x${e.toLocaleString(void 0,{minimumFractionDigits:1,maximumFractionDigits:1})}`},this.handleScoreUpdated=(t,e)=>{this.scoreText.text=`$${(~~e).toLocaleString()}`};this.titleText=t.make.bitmapText({text:"SCORE x1",size:46,font:h.gotham_ultra_italic.ID,x:-295,y:35,origin:{x:0,y:.5}}).setTint(16440601),this.scoreText=t.make.bitmapText({text:"0",size:64,font:h.gotham_ultra_italic.ID,x:-300,y:90,origin:{x:0,y:.5}}),X(this,[this.titleText,this.scoreText]),N(t,l.playerMultiplier.ID,this.handleMultiplierUpdated),N(t,l.playerScore.ID,this.handleScoreUpdated)}}class At extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.handleTimeUpdated=(t,e)=>{this.timeText.text=`${(e/1e3).toLocaleString(void 0,{maximumFractionDigits:0})}`};this.timeTitle=t.make.bitmapText({x:305,y:35,text:"TIME:",font:h.gotham_ultra_italic.ID,origin:{x:1,y:.5},size:46}).setTint(16440601),this.timeText=t.make.bitmapText({x:300,y:90,text:"60",font:h.gotham_ultra_italic.ID,origin:{x:1,y:.5},size:64}),this.add([this.timeTitle,this.timeText]),N(t,l.timeRemaining.ID,this.handleTimeUpdated)}}class Ft extends s.GameObjects.Container{constructor(t,e,i=0,a=0,r="",o=16777215,l=0,c=0,u=.5,p=1,m=64){super(t,i,a),this.event=e,this.alphaMin=u,this.alphaMax=p,this.isDown=!1,this.handlePointerOver=()=>{this.scene.tweens.add({targets:this,duration:250,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:this.alphaMax}})},this.handlePointerOut=()=>{this.scene.tweens.add({targets:this,duration:250,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:this.alphaMin}})},this.handlePointerDown=(t,e,i,s)=>{s&&s.stopPropagation&&s.stopPropagation(),this.setButtonDown(!0)},this.handlePointerUp=(t,e,i,s)=>{s&&s.stopPropagation&&s.stopPropagation(),this.isDown&&this.scene.registry.events.emit(this.event),this.setButtonDown(!1)},this.setButtonDown=t=>{this.isDown=t,this.buttonUp.alpha=t?.01:1,this.buttonDown.alpha=t?1:.01},this.buttonUp=t.make.image({key:n.ID,frame:"game/ui/button/up"}),this.buttonDown=t.make.image({key:n.ID,frame:"game/ui/button/down"}),s.Actions.SetAlpha([this.buttonUp,this.buttonDown],.5),this.alpha=this.alphaMin,this.textField=t.add.bitmapText(l,c,h.gotham_ultra_italic.ID,r,m,s.GameObjects.BitmapText.ALIGN_CENTER).setOrigin(.5),this.add([this.buttonUp,this.buttonDown,this.textField]),this.setButtonDown(!1),this.buttonDown.setInteractive({useHandCursor:!0}),this.buttonDown.on(s.Input.Events.POINTER_OVER,this.handlePointerOver),this.buttonDown.on(s.Input.Events.POINTER_OUT,this.handlePointerOut),this.buttonDown.on(s.Input.Events.POINTER_DOWN,this.handlePointerDown),this.buttonDown.on(s.Input.Events.POINTER_UP,this.handlePointerUp),this.buttonDown.on(s.Input.Events.POINTER_UP_OUTSIDE,this.handlePointerUp),s.Actions.SetTint([this.buttonDown,this.buttonUp],o)}}class Ut extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.buttonShoot=new Ft(t,p,-150,-150,"",16711680,-5,2,.5,1,64),this.add([this.buttonShoot])}}class zt extends s.GameObjects.Image{constructor(t){super(t,0,0,n.ID,"shared/transparent_pixel"),this.horizontalSpace=.6,this.margin=70,this.handleReflow=()=>{const t=I/this.scene.cameras.main.height;return this.boundaries.width=this.scene.cameras.main.width*this.horizontalSpace-2*this.margin,this.boundaries.height=this.scene.cameras.main.height-2*this.margin,this.setScale(this.scene.cameras.main.width*this.horizontalSpace/this.width*t,this.scene.cameras.main.height/this.height*t),this},this.isOutsideMargins=()=>!this.boundaries.contains(this.scene.input.x,this.scene.input.y),this.boundaries=new s.Geom.Rectangle(this.margin,this.margin,this.scene.cameras.main.width*this.horizontalSpace-2*this.margin,this.scene.cameras.main.height-2*this.margin),this.setAlpha(1).setOrigin(0,1).handleReflow().setInteractive({cursor:"all-scroll"}),V(t,u,this.handleReflow)}}class Bt extends s.GameObjects.Container{constructor(t,e=0,i=0,a=.5,r=1){super(t,0,0),this.originalX=e,this.originalY=i,this.alphaMin=a,this.alphaMax=r,this.maxRadius=80,this.pointerDown=!1,this.prevH=0,this.prevV=0,this.inputH=0,this.inputV=0,this.bindings={strings:{left:["A, LEFT"],right:["D, RIGHT"],up:["W, UP"],down:["S, X, DOWN"]},keys:{left:[],right:[],up:[],down:[]}},this.handleInputAreaPointerDown=(t,e,i,s)=>{if(this.inputArea.isOutsideMargins())return;this.stopJoystickPositionTween(),this.pointerDown=!0;const a=I/this.scene.cameras.main.height;this.joystickContainer.setPosition(this.scene.input.x*a,(this.scene.input.y-this.scene.cameras.main.height)*a)},this.handlePointerMove=()=>{let t;if(!this.pointerDown||!this.scene.input.activePointer.primaryDown)return this.pointerDown=!1,void this.handleKeyboardInput();const e=this.inputH||this.joystickBackground.input.localX-.5*this.joystickBackground.width-this.joystickBackground.x,i=this.inputV||this.joystickBackground.input.localY-.5*this.joystickBackground.height-this.joystickBackground.y;t=new s.Math.Vector2(e,i);const a=s.Math.Angle.BetweenPoints(this.joystickBackground,t);s.Math.Distance.BetweenPoints(t,this.joystickBackground)>this.maxRadius&&(t.x=Math.cos(a)*this.maxRadius,t.y=Math.sin(a)*this.maxRadius),this.setKnobPosition(t.x,t.y,!0)},this.handleKeyboardInput=()=>{this.bindings.keys.left.filter(t=>!0===t.isDown).length>0?this.inputH=-1:this.bindings.keys.right.filter(t=>!0===t.isDown).length>0?this.inputH=1:this.inputH=0,this.bindings.keys.up.filter(t=>!0===t.isDown).length>0?this.inputV=-1:this.bindings.keys.down.filter(t=>!0===t.isDown).length>0?this.inputV=1:this.inputV=0;const t=new s.Math.Vector2(this.inputH*this.maxRadius,this.inputV*this.maxRadius),e=s.Math.Angle.BetweenPoints(s.Math.Vector2.ZERO,t);s.Math.Distance.BetweenPoints(t,this.joystickBackground)>this.maxRadius&&(t.x=Math.cos(e)*this.maxRadius,t.y=Math.sin(e)*this.maxRadius),this.setKnobPosition(t.x,t.y)},this.handlePointerOver=()=>{this.scene.tweens.add({targets:this.joystickContainer,duration:250,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:this.alphaMax}})},this.handlePointerOut=()=>{},this.handlePointerDown=(t,e,i,s)=>{this.stopJoystickPositionTween(),this.pointerDown=!0;const a=I/this.scene.cameras.main.height;this.joystickContainer.setPosition(this.scene.input.x*a,(this.scene.input.y-this.scene.cameras.main.height)*a)},this.handlePointerUp=(t,e,i,s)=>{s&&s.stopPropagation&&s.stopPropagation(),this.moveContainerToOriginalPosition(),this.pointerDown=!1,this.setKnobPosition(0,0)},this.setKnobPosition=(t,e,i=!1)=>{this.scene.registry.set(l.joystickHorizontal.ID,t/this.maxRadius),this.scene.registry.set(l.joystickVertical.ID,e/this.maxRadius),this.joystickTween&&this.joystickTween.isPlaying()&&this.joystickTween.stop(),i?this.joystickKnob.setPosition(t,e):this.joystickTween=this.scene.tweens.timeline({tweens:[{targets:this.joystickKnob,ease:s.Math.Easing.Quintic.Out,duration:2*s.Math.Distance.Between(t,e,this.prevH,this.prevV),props:{x:t,y:e}}]}),this.prevH=t,this.prevV=e};for(let e in this.bindings.strings)for(let i in this.bindings.strings[e]){let a=t.input.keyboard.addKeys(this.bindings.strings[e][i]);for(let t in a)a[t].on(s.Input.Keyboard.Events.DOWN,this.handleKeyboardInput),a[t].on(s.Input.Keyboard.Events.UP,this.handleKeyboardInput),this.bindings.keys[e].push(a[t])}this.inputArea=new zt(t),this.joystickContainer=t.make.container({x:e,y:i}),this.joystickBackground=t.make.image({key:n.ID,frame:"game/ui/joystick/background"}),this.joystickKnob=t.make.image({key:n.ID,frame:"game/ui/joystick/knob"}),this.joystickContainer.add([this.joystickBackground,this.joystickKnob]),this.add([this.inputArea,this.joystickContainer]),s.Actions.SetOrigin([this.joystickBackground,this.joystickKnob],.5),this.joystickContainer.alpha=this.alphaMin,this.joystickBackground.setInteractive({cursor:"cell"}),this.joystickBackground.on(s.Input.Events.POINTER_OVER,this.handlePointerOver),this.joystickBackground.on(s.Input.Events.POINTER_OUT,this.handlePointerOut),this.joystickBackground.on(s.Input.Events.POINTER_DOWN,this.handlePointerDown),this.joystickBackground.on(s.Input.Events.POINTER_UP,this.handlePointerUp),this.joystickBackground.on(s.Input.Events.POINTER_UP_OUTSIDE,this.handlePointerUp),this.inputArea.on(s.Input.Events.POINTER_UP,this.handlePointerUp),this.inputArea.on(s.Input.Events.POINTER_UP_OUTSIDE,this.handlePointerUp),this.inputArea.on(s.Input.Events.POINTER_DOWN,this.handleInputAreaPointerDown),this.joystickBackground.on(s.Input.Events.POINTER_MOVE,this.handlePointerMove)}stopJoystickPositionTween(){this.joystickPositionTween&&this.joystickPositionTween.isPlaying()&&(this.joystickPositionTween.stop(),this.joystickPositionTween=null)}moveContainerToOriginalPosition(){this.stopJoystickPositionTween(),this.joystickPositionTween=this.scene.tweens.timeline({tweens:[{targets:this.joystickContainer,duration:250,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:this.alphaMin}},{targets:this.joystickContainer,offset:0,duration:250,ease:s.Math.Easing.Back.Out,props:{x:this.originalX,y:this.originalY}}]})}}class Xt extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.joystick=new Bt(t,150,-150),this.add([this.joystick])}}class Nt extends s.Scene{constructor(){super({key:x.ID}),this.dirty=!1,this.distance=0,this.score=0,this.allLoaded=!1,this.isSafe=!1,this.targetX=0,this.targetY=0,this.targetZ=0,this.targetCameraRotation=0,this.rotationVerticalMax=.5,this.joystick={x:0,y:0},this.crashed=!1,this.forwardHitDetectionMultiplier=new a.h(7,7,7),this.lastHeightCheck=0,this.heightCheckInterval=100,this.handleAllLoaded=()=>{this.addEventListeners(),this.initDefaultValues(),this.initUI(),this.startMultiplierDecreaserThing(),this.tweens.add({targets:[this.containerTopCenter],ease:s.Math.Easing.Quadratic.Out,duration:1e3,delay:1e3,alpha:{start:0,to:1}}),this.allLoaded=!0,this.loadingOverlay.requestCompleted(),this.handleReflow()},this.initUI=()=>{this.scoreDisplay=new Lt(this),this.timeDisplay=new At(this),this.crashEffect=new Tt(this),this.uiTimer=new Ot(this),this.controlsBottomLeft=new Xt(this),this.controlsBottomRight=new Ut(this),this.scoreFloaterPool=new Rt(this,0,.25*this.cameras.main.height),this.containerCentered.add([this.crashEffect,this.uiTimer,this.scoreFloaterPool]),this.containerTopCenter.add([this.scoreDisplay,this.timeDisplay]),this.containerBottomLeft.add([this.controlsBottomLeft]),this.containerBottomRight.add([this.controlsBottomRight])},this.addEventListeners=()=>{this.registry.set(l.playerDistance.ID,l.playerDistance.DEFAULT),this.registry.set(l.timeRemaining.ID,l.timeRemaining.DEFAULT),this.registry.set(l.playerScore.ID,l.playerScore.DEFAULT),this.registry.set(l.playerSpeed.ID,l.playerSpeed.DEFAULT),this.registry.set(l.playerMultiplier.ID,l.playerMultiplier.DEFAULT),V(this,b,this.handlePlayerCrashed),V(this,S,this.handleScoreAdd),V(this,v,this.handleMultiplierAdd),N(this,l.playerSpeed.ID,(t,e)=>{this.speed=e}),N(this,l.joystickHorizontal.ID,this.handleInputJoystick),N(this,l.joystickVertical.ID,this.handleInputJoystick)},this.initDefaultValues=()=>{this.distance=0,this.crashed=!1,this.speed=w.SPEED_NORMAL},this.initContainers=()=>{this.containerCentered=this.add.container(this.cameras.main.centerX,this.cameras.main.centerY,[this.loadingOverlay]),this.containerTopCenter=this.add.container(this.cameras.main.centerX,0),this.containerBottomCenter=this.add.container(this.cameras.main.centerX,this.cameras.main.height),this.containerBottomLeft=this.add.container(0,this.cameras.main.height),this.containerBottomRight=this.add.container(this.cameras.main.width,this.cameras.main.height),this.containers=[this.containerCentered,this.containerTopCenter,this.containerBottomCenter,this.containerBottomLeft,this.containerBottomRight],this.containerTopCenter.alpha=0},this.handleTerrainCollisions=()=>{this.time.now>this.lastHeightCheck+this.heightCheckInterval&&this.checkForTerrainCollision()&&this.registry.events.emit(b)},this.handleInput=t=>{let e=this.main3d.player.rotation.y;this.targetX=this.targetY=this.targetZ=0,this.keys.SPACE.isDown||this.keys.SHIFT.isDown||this.keys.CONTROL.isDown||this.keys.ALT.isDown||this.controlsBottomRight.buttonShoot.isDown?this.speed=s.Math.Clamp(this.speed+t*w.ACCELERATION_MULTIPLIER,w.SPEED_MIN,w.SPEED_MAX):this.speed=s.Math.Clamp(this.speed-t*w.DECELERATION_MULTIPLIER,w.SPEED_MIN,w.SPEED_MAX),this.targetX-=this.joystick.y*this.rotationVerticalMax,this.targetY+=this.joystick.x*this.rotationVerticalMax,this.main3d.player.rotation.x+=(this.targetX-this.main3d.player.rotation.x)*t*.001,this.main3d.player.rotation.y+=this.targetY*t*.001,this.targetZ=-60*(this.main3d.player.rotation.y-e),this.main3d.player.rotation.z+=(this.targetZ-this.main3d.player.rotation.z)*t*.003,this.main3d.engine.camera.rotationOffset=180},this.moveForward=t=>{const e=t*this.speed;this.registry.set(l.playerPosition.ID,this.registry.get(l.playerPosition.ID).add(this.main3d.player.forward.multiply(a.h.FromArray([e,e,e]))))},this.checkForTerrainCollision=()=>{this.lastHeightCheck=this.time.now;const t=this.main3d.player.position.add(this.main3d.player.forward.multiply(this.forwardHitDetectionMultiplier));return this.main3d.player.position.y-this.main3d.terrain.terrain.getHeightFromMap(Math.round(t.x),Math.round(t.z),{})<1},this.startMultiplierDecreaserThing=()=>{let t=0;this.time.addEvent({loop:!0,delay:500,callback:()=>{t=this.registry.get(l.playerMultiplier.ID),this.registry.set(l.playerMultiplier.ID,Math.max(w.MULTIPLIER_MIN,t-t*w.MULTIPLIER_DECAY_SPEED))}})},this.handleScoreAdd=t=>{this.registry.set(l.playerScore.ID,this.registry.get(l.playerScore.ID)+t)},this.handleMultiplierAdd=t=>{this.registry.set(l.playerMultiplier.ID,this.registry.get(l.playerMultiplier.ID)+t)},this.handleInputJoystick=()=>{this.joystick.x=this.registry.get(l.joystickHorizontal.ID),this.joystick.y=this.registry.get(l.joystickVertical.ID)},this.handleReflow=()=>{s.Actions.SetScale(this.containers,this.cameras.main.height/I),this.containerCentered.setPosition(this.cameras.main.centerX,this.cameras.main.centerY),this.containerTopCenter.setPosition(this.cameras.main.centerX,0),this.containerBottomCenter.setPosition(this.cameras.main.centerX,this.cameras.main.height),this.containerBottomLeft.setPosition(0,this.cameras.main.height),this.containerBottomRight.setPosition(this.cameras.main.width,this.cameras.main.height),this.controlsBottomLeft&&this.controlsBottomLeft.joystick.joystickContainer.setPosition(this.controlsBottomLeft.joystick.originalX,this.controlsBottomLeft.joystick.originalY)},this.handleGameOver=()=>{this.scene.start(T.ID)},this.handlePlayerCrashed=()=>{this.crashed=!0,this.main3d.engine.camera.setTarget(this.main3d.player.position.clone()),this.main3d.player.dispose();const t=this.make.sprite({key:r.explosion.key}),e=r.explosion;t.play(e.animationKey,!0,0),t.setScale(10),this.containerCentered.add(t);this.tweens.timeline({tweens:[{targets:t,duration:150,ease:s.Math.Easing.Quintic.Out,props:{alpha:{start:0,to:1}}},{offset:1e3*e.end/e.frameRate-550,targets:t,duration:550,ease:s.Math.Easing.Quadratic.InOut,props:{alpha:{from:1,to:0}}},{offset:0,targets:t,duration:1e3*e.end/e.frameRate*.5,ease:s.Math.Easing.Quadratic.Out,props:{scale:5}},{offset:0,targets:this.main3d.engine.camera,duration:1e3*e.end/e.frameRate,ease:s.Math.Easing.Quintic.Out,props:{heightOffset:100}}],onComplete:()=>{this.handleGameOver()}})}}create(){V(this,u,this.handleReflow),this.loadingOverlay=new kt(this),this.initContainers(),this.main3d=new xt(this),this.keys=this.input.keyboard.addKeys("W,A,S,D,X,UP,DOWN,LEFT,RIGHT,SPACE,SHIFT,CONTROL,ALT"),this.main3d.loadAssets().then(this.main3d.initScene).then(this.handleAllLoaded)}update(t,e){if(!this.allLoaded||this.crashed)return;this.main3d.projectiles&&this.main3d.projectiles.requestShoot(),this.registry.events.emit(S,e*this.speed*w.SCORE_MULTIPLIER*(this.registry.get(l.playerMultiplier.ID)+1)),this.registry.set(l.playerSpeed.ID,this.speed),this.distance+=e,this.registry.set(l.playerDistance,this.distance);const i=this.registry.get(l.timeRemaining.ID)-e;if(!this.input.activePointer.primaryDown&&this.controlsBottomLeft.joystick.pointerDown&&this.controlsBottomLeft.joystick.handlePointerUp(),i<=0)return this.registry.set(l.timeRemaining.ID,0),void this.handleGameOver();this.registry.set(l.timeRemaining.ID,i),this.handleInput(e),this.moveForward(e),this.handleTerrainCollisions()}}class Vt extends s.GameObjects.Container{constructor(t,e=0,i=0){super(t,e,i),this.displayedScore=0,this.targetScore=0,this.targetScore=t.registry.get(l.playerScore.ID),this.scoreTitle=t.make.bitmapText({x:0,y:0,font:h.gotham_ultra_italic.ID,text:"CASH:",size:72,origin:.5}).setTint(16776960),this.scoreText=t.make.bitmapText({x:0,y:100,font:h.gotham_ultra_italic.ID,text:"0",size:100,origin:.5}),t.tweens.add({targets:this,duration:3e3,ease:s.Math.Easing.Quadratic.Out,displayedScore:{start:0,to:this.targetScore},onUpdate:()=>{this.scoreText.text=`$${(~~this.displayedScore).toLocaleString()}`}}),t.tweens.timeline({tweens:[{targets:this.scoreTitle,duration:1e3,ease:s.Math.Easing.Back.Out,props:{x:{start:-100,to:0}}},{offset:100,targets:this.scoreText,duration:1250,ease:s.Math.Easing.Back.Out,props:{x:{start:100,to:0}}}]}),t.tweens.add({targets:this,duration:500,ease:s.Math.Easing.Back.Out,scale:{start:.5,to:1}}),t.tweens.add({targets:this,duration:800,ease:s.Math.Easing.Quadratic.Out,alpha:{start:0,to:1}}),this.add([this.scoreTitle,this.scoreText])}}class jt extends s.Scene{constructor(){super({key:T.ID}),this.handlePlayClicked=(t,e)=>{location.reload()},this.handleReflow=()=>{this.centeredContainer.setScale(this.cameras.main.height/I),this.centeredContainer.setPosition(this.cameras.main.centerX,this.cameras.main.centerY)}}create(){V(this,u,this.handleReflow),this.background=new B(this,0,-.25*I),this.score=new Vt(this,0,.03*I),this.playButton=new j(this,0,.3*I),this.playButton.button.on(s.Input.Events.POINTER_UP,this.handlePlayClicked),this.centeredContainer=this.add.container(this.cameras.main.centerX,this.cameras.main.centerY,[this.background,this.score,this.playButton]),this.tweens.timeline({tweens:[{targets:this.background.bg,duration:500,ease:s.Math.Easing.Back.Out,props:{y:{start:-100,to:0},alpha:{start:0,to:1}}},{offset:100,targets:this.background.topText,duration:500,ease:s.Math.Easing.Back.Out,props:{x:{start:-100,to:0},alpha:{start:0,to:1}}},{offset:100,targets:this.background.bottomText,duration:500,ease:s.Math.Easing.Back.Out,props:{x:{start:100,to:0},alpha:{start:0,to:1}}},{offset:300,targets:this.playButton,duration:1e3,ease:s.Math.Easing.Quintic.Out,props:{y:{start:this.playButton.y+100,to:this.playButton.y},alpha:{start:0,to:1}}}]}),this.handleReflow()}}class Zt{constructor(t){this.scene=t,this.music={},this.sounds={},this.currentMusic=null,this.handleFocus=()=>{this.scene.sound.mute=this.scene.registry.get(l.audioMute.ID)},this.handleBlur=()=>{this.scene.sound.mute=!0},this.handleStopMusic=()=>{this.currentMusic&&this.currentMusic.stop&&this.currentMusic.stop()},this.requestMusic=t=>{for(let t in L)this.music[L[t].id].pause();this.currentMusic=this.music[t],requestAnimationFrame(()=>{this.music[t].rate=1,this.music[t].play({loop:!0})})},this.requestSound=t=>{this.sounds[t].play({seek:0})},this.handleMutedChanged=()=>{this.scene.sound.mute=this.scene.registry.get(l.audioMute.ID)};for(let e in L)this.music[L[e].id]=t.sound.add(L[e].id);for(let e in A)this.sounds[A[e].id]=t.sound.add(A[e].id);V(t,d,this.requestMusic),V(t,g,this.requestSound),t.sound.mute="true"===localStorage.getItem(l.audioMute.ID),N(t,l.audioMute.ID,this.handleMutedChanged),t.registry.set(l.music.ID,this.music),t.game.events.on(Phaser.Core.Events.FOCUS,this.handleFocus),t.game.events.on(Phaser.Core.Events.BLUR,this.handleBlur),V(t,_,this.handleStopMusic)}}class Ht extends s.Scene{constructor(){super({key:O.ID}),this.resizeRequest=5,this.lastInnerHeight=0,this.previousResolution={width:0,height:0}}create(){this.phaserCanvas=document.getElementById("phaser-canvas"),this.sound.mute=this.registry.get(l.audioMute.ID),this.sound.volume=this.registry.get(l.audioVolume.ID),this.audioManager=new Zt(this),N(this,l.audioVolume.ID,(t,e,i)=>{this.sound.volume=e,localStorage.setItem(l.audioVolume.ID,""+Phaser.Math.RoundTo(e,-2))}),N(this,l.audioMute.ID,(t,e,i)=>{this.sound.mute=e,localStorage.setItem(l.audioMute.ID,""+e)})}update(){this.previousResolution.width===window.innerWidth&&this.previousResolution.height===window.innerHeight||(this.registry.events.emit(u),this.resizeRequest=5,this.previousResolution.width=window.innerWidth,this.previousResolution.height=window.innerHeight),this.lastInnerHeight!==window.innerHeight&&(this.resizeRequest=5,this.lastInnerHeight=window.innerHeight),this.resizeRequest<=0||(this.resizeRequest--,window.scrollTo(1,0),this.registry.events.emit(u),this.phaserCanvas.style.left=`${.5*window.innerWidth-.5*this.phaserCanvas.width*(window.innerHeight/this.phaserCanvas.height)}px`,this.phaserCanvas.style.height=`${window.innerHeight}px`,this.scale.resize(window.innerWidth,window.innerHeight))}}class Gt extends s.Game{constructor(){super({type:s.WEBGL,canvas:document.getElementById("phaser-canvas"),title:"AvatarLabs Flying Prototype",version:"0.0.1",autoFocus:!0,disableContextMenu:!0,width:D,height:I,render:{transparent:!0,clearBeforeRender:!0,powerPreference:"high-performance"},loader:{crossOrigin:"anonymous",async:!0},scale:{autoRound:!0,mode:s.Scale.ScaleModes.NONE},input:{activePointers:10},scene:[F,z,Z,Nt,jt,Ht]}),this.events.on(Phaser.Core.Events.BLUR,()=>{this.scene.pause(x.ID)}),this.events.on(Phaser.Core.Events.FOCUS,()=>{this.scene.resume(x.ID)})}}new class{constructor(){new Gt}}},724:function(t,e,i){var s=i(725),a=i(726);"string"==typeof(a=a.__esModule?a.default:a)&&(a=[[t.i,a,""]]);var n={insert:"head",singleton:!1},r=(s(a,n),a.locals?a.locals:{});t.exports=r},726:function(t,e,i){(e=i(727)(!1)).push([t.i,"html,\nbody {\n  width: 100vw;\n  height: 100vh;\n  background: black;\n}\n\nhtml, body, canvas {\n  overflow: hidden;\n  margin: 0;\n  padding: 0;\n  border: 0;\n  position: absolute;\n}\n\n#babylon-canvas,\n#phaser-canvas {\n  touch-action: none;\n}\n",""]),t.exports=e}},[[1645,3,2,1,4]]]);